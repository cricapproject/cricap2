{% extends "master.html" %}
{% load static %}

{% block title %}Report - CRICAP{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="{% static 'assets/css/dashboard.css' %}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: 20px auto;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 20px;
    }
    .header {
      background: #007bff;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 10px 10px 0 0;
      margin: -20px -20px 20px -20px;
    }
    .content p { font-size: 18px; margin: 10px 0; }
    .category {
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 5px;
      display: inline-block;
    }
    .Rendah { background-color: #ffd700; color: black; }
    .Sedang { background-color: #adff2f; color: black; }
    .Tinggi { background-color: #32cd32; color: white; }
    .btn {
      display: inline-block; margin: 10px 5px; padding: 10px 20px;
      background-color: #007bff; color: white; text-decoration: none; border-radius: 5px;
    }
    .btn:hover { background-color: #0056b3; }
    .chart-row {
      display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
    }
    .chart-box { flex: 1 1 340px; text-align: center; min-width: 280px; }
    canvas { margin-top: 20px; max-width: 100%; }
    .irk-box {
      border: 1px solid #007bff; border-radius: 8px;
      padding: 10px 15px; margin-bottom: 8px;
      background-color: #f1f8ff; font-size: 16px;
    }
    .small {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
{% endblock %}

{% block content %}
<div class="dashboard d-flex flex-column min-vh-">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">CRICAP Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <form class="d-flex ms-auto">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                </form>
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="{% static 'assets/img/User-Profile.jpeg' %}" alt="User Profile" class="rounded-circle me-2" width="32" height="32">
                            Hello, {{user}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><a class="dropdown-item" href="#">Messages</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Sign out</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'survey_user' %}">
                                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-activity"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                                Credit Analysis
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'report' %}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                                Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'home' %}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard-home' %}">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Reports</li>
                    </ol>
                </nav>

                <!-- VISUALISASI -->
                <div class="container">
                    <div class="header"><h2>Visualisasi Distribusi Pekerjaan</h2></div>
                    <div class="chart-row">
                    <!-- Pie Chart Pekerjaan -->
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h4>Distribusi pekerjaan dari <strong>{{ total_orang|default:"0" }}</strong> orang</h4>
                    <div style="width: 550px; height: 430px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="pekerjaanChart"></canvas>
                    </div>
                    </div>
                </div>
                </div>

                <!-- HASIL PENGUKURAN IRK (DALAM 1 BOX) -->
                <div class="container">
                    <div class="header"><h2>Hasil Pengukuran IRK</h2></div>
                    <div class="content">

                        <!-- LIST PEKERJAAN BERDASARKAN KATEGORI IRK -->
                        <div class="irk-box" style="margin-top:20px;">
                        <h3>PEKERJAAN :</h3>
                        <!-- INFO JUMLAH DISTRIBUSI -->
                        <p style="margin-top:8px; font-style:italic; color:#555;">
                        Distribusi pekerjaan dari <strong>{{ total_orang|default:"0" }}</strong> orang
                        </p>

                        <!-- IRK Tinggi -->
                        <div class="irk-box small">
                            <h4>Pekerjaan IRK Tinggi</h4>
                            {% for d in avg_irk_per_pekerjaan %}
                            {% if d.pekerjaan != "-" and d.avg_irk >= 60 %}
                                <p>Pekerjaan <b>{{ d.pekerjaan }}</b> → <b>{{ d.avg_irk|floatformat:"2" }}</b></p>
                            {% endif %}
                            {% empty %}
                            <p>Tidak ada data</p>
                            {% endfor %}
                        </div>

                        <!-- IRK Sedang -->
                        <div class="irk-box small">
                            <h4>Pekerjaan IRK Sedang</h4>
                            {% for d in avg_irk_per_pekerjaan %}
                            {% if d.pekerjaan != "-" and d.avg_irk >= 40 and d.avg_irk < 60 %}
                                <p>Pekerjaan <b>{{ d.pekerjaan }}</b> → <b>{{ d.avg_irk|floatformat:"2" }}</b></p>
                            {% endif %}
                            {% empty %}
                            <p>Tidak ada data</p>
                            {% endfor %}
                        </div>

                        <!-- IRK Rendah -->
                        <div class="irk-box small">
                            <h4>Pekerjaan IRK Rendah</h4>
                            {% with found=False %}
                            {% for d in avg_irk_per_pekerjaan %}
                                {% if d.pekerjaan != "-" and d.avg_irk > 0 and d.avg_irk < 40 %}
                                {% if not found %}{% with found=True %}{% endwith %}{% endif %}
                                <p>Pekerjaan <b>{{ d.pekerjaan }}</b> → <b>{{ d.avg_irk|floatformat:"2" }}</b></p>
                                {% endif %}
                            {% endfor %}
                            {% if not found %}
                                <p>Tidak ada data</p>
                            {% endif %}
                            {% endwith %}
                        </div>
                    
                        <!-- === BAR CHART RATA-RATA IRK PER PEKERJAAN === -->
                        <div class="col-md-12 d-flex justify-content-center" style="margin-top: 10px;">
                        <div style="width: 100%; max-width: 700px; text-align: center;">
                            <h5 style="margin-bottom: 15px; font-weight: 600; color: #003366;">
                            Rata-rata IRK per Pekerjaan
                            </h5>
                            <canvas id="avgIrkPekerjaanChart" style="width: 100%; height: 400px;"></canvas>
                        </div>
                        </div>
                    </div>

                    <!-- WILAYAH -->
                    <div class="irk-box" style="margin-top:20px;">
                        <h3>WILAYAH :</h3>

                        <!-- DROPDOWN PILIH WILAYAH -->
                        <div style="margin-bottom:15px;">
                        <label for="wilayahSelect" style="font-weight:bold; margin-right:10px;">Kategori Wilayah:</label>
                        <select id="wilayahSelect" style="padding:6px 10px; border-radius:5px; border:1px solid #ccc;">
                            <option value="kecamatan" selected>Per Kecamatan</option>
                            <option value="desa">Per Desa</option>
                        </select>
                        </div>

                        <!-- KELOMPOK KECAMATAN -->
                        <div id="wilayah-kecamatan">
                        {% if samples_kecamatan %}
                            {% if samples_kecamatan.all|length > 9 %}
                            <!-- Lebih dari 9 data → tampilkan 3 kecamatan per kategori -->
                            
                            <!-- Tinggi -->
                            <div class="irk-box small">
                                <h4>3 Kecamatan IRK Tinggi</h4>
                                {% for s in samples_kecamatan.tinggi %}
                                <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>

                            <!-- Sedang -->
                            <div class="irk-box small">
                                <h4>3 Kecamatan IRK Sedang</h4>
                                {% for s in samples_kecamatan.sedang %}
                                {% if forloop.first %}
                                    <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% elif forloop.last %}
                                    <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% else %}
                                    <p>(Tengah) Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% endif %}
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>

                            <!-- Rendah -->
                            <div class="irk-box small">
                                <h4>Kecamatan IRK Rendah</h4>
                                {% for s in samples_kecamatan.rendah %}
                                {% if s.kecamatan and s.kecamatan != "-" and s.avg_irk|default:0|floatformat:"2" != "0.00" and s.avg_irk > 0 %}
                                    <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% endif %}
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>

                            {% else %}
                            <!-- Kalau <= 9 data → tampilkan semua -->
                            
                            <!-- Tinggi -->
                            <div class="irk-box small">
                                <h4>Kecamatan IRK Tinggi</h4>
                                {% for s in samples_kecamatan.tinggi %}
                                <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>

                            <!-- Sedang -->
                            <div class="irk-box small">
                                <h4>Kecamatan IRK Sedang</h4>
                                {% for s in samples_kecamatan.sedang %}
                                <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>

                            <!-- Rendah -->
                            <div class="irk-box small">
                                <h4>Kecamatan IRK Rendah</h4>
                                {% for s in samples_kecamatan.rendah %}
                                <p>Kecamatan <b>{{ s.kecamatan }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                                {% empty %}
                                <p>Tidak ada data</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% else %}
                            <p>Tidak ada data</p>
                        {% endif %}
                        </div>


                        <!-- KELOMPOK DESA -->
                        <div id="wilayah-desa" style="display:none;">
                        <div class="irk-box small">
                            <h4>3 Desa IRK Tinggi</h4>
                            {% for s in samples_desa.tinggi %}
                            <p>Desa <b>{{ s.desa }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                            {% empty %}
                            <p>Tidak ada data</p>
                            {% endfor %}
                        </div>

                        <div class="irk-box small">
                            <h4>3 Desa IRK Sedang</h4>
                            {% for s in samples_desa.sedang %}
                            {% if forloop.first %}
                                <p>Desa <b>{{ s.desa }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                            {% elif forloop.last %}
                                <p>Desa <b>{{ s.desa }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                            {% else %}
                                <p>(Tengah) Desa <b>{{ s.desa }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                            {% endif %}
                            {% empty %}
                            <p>Tidak ada data</p>
                            {% endfor %}
                        </div>

                        <div class="irk-box small">
                            <h4>3 Desa IRK Rendah</h4>
                            {% for s in samples_desa.rendah %}
                            <p>Desa <b>{{ s.desa }}</b> → <b>{{ s.avg_irk|floatformat:"2" }}</b></p>
                            {% empty %}
                            <p>Tidak ada data</p>
                            {% endfor %}
                        </div>
                        </div>

                <script>
                        // Toggle Kecamatan / Desa
                        document.getElementById("wilayahSelect").addEventListener("change", function() {
                        let val = this.value;
                        document.getElementById("wilayah-kecamatan").style.display = (val === "kecamatan") ? "block" : "none";
                        document.getElementById("wilayah-desa").style.display = (val === "desa") ? "block" : "none";
                        });
                    </script>


                <script>
                    // --- DATA UNTUK CHART ---
                    const ctxPekerjaan = document.getElementById('pekerjaanChart');
                    const ctxIRK = document.getElementById('irkChart');
                    const ctxAvg = document.getElementById('avgIrkPekerjaanChart');

                    const labelsP = [{% for d in pekerjaan_distribution %}'{{ d.pekerjaan }}',{% endfor %}];
                    const dataP = [{% for d in pekerjaan_distribution %}{{ d.count }},{% endfor %}];
                    const percentagesP = [{% for d in pekerjaan_distribution %}{{ d.percentage }},{% endfor %}];

                    const colorMap = {
                    'ASN/TNI/Polri/Pegawai BUMN': '#003366',
                    'Pengusaha/Pedagang/Kontraktor': '#004C99',
                    'Karyawan swasta/Profesional non PNS': '#0066CC',
                    'IRT/Pelajar/Mahasiswa/Belum (Tidak) Bekerja': '#3399FF',
                    'Buruh harian/Ojek Online/Petani/Nelayan/Peternak/Freelancer': '#99CCFF'
                    };

                    const irkValue = {{ irk|default:0|floatformat:"2" }};
                    const avgIRK = {{ avg_irk_pekerjaan|default:0|floatformat:"2" }};
                    const avgIrkLabels = [
                    {% for d in avg_irk_per_pekerjaan %}
                        {% if d.pekerjaan != "-" and d.avg_irk > 0 %}
                        '{{ d.pekerjaan }}',
                        {% endif %}
                    {% endfor %}
                    ];
                    const avgIrkValues = [
                    {% for d in avg_irk_per_pekerjaan %}
                        {% if d.pekerjaan != "-" and d.avg_irk > 0 %}
                        {{ d.avg_irk }},
                        {% endif %}
                    {% endfor %}
                    ];
                    const avgIrkColors = avgIrkValues.map(v => v<40? '#FFD700' : v<60? '#ADFF2F' : '#32CD32');

                    // Tambahkan total orang per pekerjaan di legend
                    const labelsWithCount = [{% for d in pekerjaan_distribution %}'{{ d.pekerjaan }} ({{ d.count }})',{% endfor %}];

                    new Chart(ctxPekerjaan, {
                    type: 'pie',
                    data: {
                        labels: labelsP,
                        datasets: [{
                        data: dataP,
                        backgroundColor: labelsP.map(l => colorMap[l.replace(/'/g,"")] || '#ccc')
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                            generateLabels: function(chart) {
                                return chart.data.labels.map((label, i) => ({
                                text: labelsWithCount[i],      // pakai labelsWithCount
                                fillStyle: chart.data.datasets[0].backgroundColor[i],
                                strokeStyle: chart.data.datasets[0].backgroundColor[i],
                                hidden: false,
                                index: i
                                }));
                            }
                            }
                        },
                        tooltip: {
                            callbacks: {
                            label: function(c) { 
                                return `${labelsWithCount[c.dataIndex]}: ${percentagesP[c.dataIndex]}%`; // pakai labelsWithCount
                            }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: function(v, c) { 
                            return percentagesP[c.dataIndex] ? percentagesP[c.dataIndex].toFixed(1) + '%' : ''; 
                            }
                        }
                        }
                    },
                    plugins: [ChartDataLabels]
                    });

                    new Chart(ctxIRK, {
                    type: 'bar',
                    data: {
                        labels: ['IRK Anda','Rata-rata Pekerjaan'],
                        datasets: [{
                        data: [irkValue, avgIRK],
                        backgroundColor: ['#007bff','#ff9800']
                        }]
                    },
                    options: {
                        plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(v){ return parseFloat(v).toFixed(2); }
                        }
                        },
                        scales: { y: { suggestedMin:0, suggestedMax:100 } }
                    },
                    plugins:[ChartDataLabels]
                    });

                    new Chart(ctxAvg, {
                    type: 'bar',
                    data: {
                        labels: avgIrkLabels,
                        datasets: [{
                        data: avgIrkValues,
                        backgroundColor: avgIrkColors,
                        barThickness: 36
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        layout: { padding: { left: 10, right: 30 } },
                        plugins: {
                        legend: {
                            display: true,
                            labels: {
                            generateLabels: function(chart) {
                                return [
                                { text: 'Rendah (<40)', fillStyle: '#FFD700' },
                                { text: 'Sedang (40–59.99)', fillStyle: '#ADFF2F' },
                                { text: 'Tinggi (60–100)', fillStyle: '#32CD32' }
                                ];
                            }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            formatter: function(v){ return parseFloat(v).toFixed(2); },
                            font: { size: 12 }
                        }
                        },
                        scales: {
                        x: { suggestedMax: 100, title: { display: true, text: "Nilai IRK (0–100)" } },
                        y: { ticks: { font: { size: 14 }, padding: 2 } }
                        }
                    },
                    plugins: [ChartDataLabels]
                    });
                </script>
                    </div>
                    </div>
                </div>



                <!-- HASIL PENGUKURAN IRK (DALAM 1 BOX) -->
                <div class="container">
                    <div class="header"><h2>Cluster Wilayah Berdasarkan IRK</h2></div>
                    <div class="content">
                    <form method="get" style="margin-bottom:10px;">
                    <label>Pilih level: </label>
                    <select name="level" onchange="this.form.submit()">
                        <option value="desa" {% if level == "desa" %}selected{% endif %}>Desa</option>
                        <option value="kecamatan" {% if level == "kecamatan" %}selected{% endif %}>Kecamatan</option>
                        <option value="both" {% if level == "both" %}selected{% endif %}>Keduanya</option>
                    </select>
                    </form>

                    <div>
                    {{ map_html|safe }}
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<script>
    // Toggle Wilayah
    document.getElementById("wilayahSelect").addEventListener("change", function() {
        const val = this.value;
        document.getElementById("wilayah-kecamatan").style.display = (val === "kecamatan") ? "block" : "none";
        document.getElementById("wilayah-desa").style.display = (val === "desa") ? "block" : "none";
    });

    // Sort Pekerjaan
    const sortRange = document.getElementById("sortRange");
    const pekerjaanList = document.getElementById("pekerjaanList");
    const highlightTitle = document.getElementById("highlightTitle");
    const highlightText = document.getElementById("highlightText");
    const originalItems = Array.from(pekerjaanList.children);

    function updateHighlight(items, mode) {
        if (!items.length) return;
        const target = mode === "desc" ? items[0] : items[items.length - 1];
        const [pekerjaan, irk] = target.innerText.split("→").map(s => s.trim());

        if (mode === "desc") {
            highlightTitle.textContent = "Tertinggi";
            highlightText.innerHTML = `Pekerjaan dengan IRK tertinggi adalah <b>${pekerjaan}</b> (${irk}).`;
        } else {
            highlightTitle.textContent = "Terendah";
            highlightText.innerHTML = `Pekerjaan dengan IRK terendah adalah <b>${pekerjaan}</b> (${irk}).`;
        }
    }

    function sortItems() {
        let items = [...originalItems];
        if (sortRange.value == "1") {
            items.sort((a, b) => parseFloat(a.innerText.split("→")[1]) - parseFloat(b.innerText.split("→")[1]));
            updateHighlight(items, "asc");
        } else {
            items.sort((a, b) => parseFloat(b.innerText.split("→")[1]) - parseFloat(a.innerText.split("→")[1]));
            updateHighlight(items, "desc");
        }
        pekerjaanList.innerHTML = "";
        items.forEach(i => pekerjaanList.appendChild(i));
    }

    sortItems();
    sortRange.addEventListener("input", sortItems);

    // Chart Data
    const labelsP = [{% for d in pekerjaan_distribution %}'{{ d.pekerjaan }}',{% endfor %}];
    const dataP = [{% for d in pekerjaan_distribution %}{{ d.count }},{% endfor %}];
    const percentagesP = [{% for d in pekerjaan_distribution %}{{ d.percentage }},{% endfor %}];

    const colorMap = {
        'ASN/TNI/Polri/Pegawai BUMN': '#003366',
        'Pengusaha/Pedagang/Kontraktor': '#004C99',
        'Karyawan swasta/Profesional non PNS': '#0066CC',
        'IRT/Pelajar/Mahasiswa/Belum (Tidak) Bekerja': '#3399FF',
        'Buruh harian/Ojek Online/Petani/Nelayan/Peternak/Freelancer': '#99CCFF'
    };

    const irkValue = {{ irk|default:0|floatformat:"2" }};
    const avgIRK = {{ avg_irk_pekerjaan|default:0|floatformat:"2" }};
    const avgIrkLabels = [{% for d in avg_irk_per_pekerjaan %}'{{ d.pekerjaan }}',{% endfor %}];
    const avgIrkValues = [{% for d in avg_irk_per_pekerjaan %}{{ d.avg_irk }},{% endfor %}];
    const avgIrkColors = avgIrkValues.map(v => v < 40 ? '#FFD700' : v < 60 ? '#ADFF2F' : '#32CD32');

    // Pie Chart
    new Chart(document.getElementById('pekerjaanChart'), {
        type: 'pie',
        data: {
            labels: labelsP,
            datasets: [{
                data: dataP,
                backgroundColor: labelsP.map(l => colorMap[l] || '#ccc')
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(c) { 
                            return `${labelsP[c.dataIndex]}: ${dataP[c.dataIndex]} (${percentagesP[c.dataIndex]}%)`;
                        }
                    }
                },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 12 },
                    formatter: function(v, c) { 
                        return percentagesP[c.dataIndex] ? percentagesP[c.dataIndex].toFixed(1) + '%' : '';
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Bar Chart IRK
    new Chart(document.getElementById('irkChart'), {
        type: 'bar',
        data: {
            labels: ['IRK Anda', 'Rata-rata Pekerjaan'],
            datasets: [{
                data: [irkValue, avgIRK],
                backgroundColor: ['#667eea', '#764ba2']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 12 },
                    formatter: function(v) { return parseFloat(v).toFixed(2); }
                }
            },
            scales: { y: { beginAtZero: true, suggestedMax: 100 } }
        },
        plugins: [ChartDataLabels]
    });

    // === VISUALISASI IRK PER PEKERJAAN ===
    const canvasAvg = document.getElementById('avgIrkPekerjaanChart');
    canvasAvg.height = Math.max(220, avgIrkLabels.length * 40);

    new Chart(canvasAvg, {
    type: 'bar',
    data: {
        labels: avgIrkLabels,
        datasets: [{
        label: 'Rata-rata IRK per Pekerjaan',
        data: avgIrkValues,
        backgroundColor: avgIrkColors,
        borderRadius: 6,
        barThickness: 25,
        categoryPercentage: 0.7,
        barPercentage: 0.9
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
        legend: {
            display: true,
            position: 'top',
            labels: {
            boxWidth: 15,
            padding: 15,
            font: { size: 12 },
            generateLabels: function() {
                return [
                { text: 'Rendah (<40)', fillStyle: '#FFD700' },
                { text: 'Sedang (40–59.99)', fillStyle: '#ADFF2F' },
                { text: 'Tinggi (60–100)', fillStyle: '#32CD32' }
                ];
            }
            }
        },
        datalabels: {
            anchor: 'end',
            align: 'right',
            color: '#333',
            font: { weight: 'bold', size: 12 },
            formatter: v => v.toFixed(2)
        }
        },
        scales: {
        x: {
            beginAtZero: true,
            suggestedMax: 100,
            grid: { color: '#ddd' },
            title: {
            display: true,
            text: 'Nilai IRK (0–100)',
            font: { size: 13, weight: 'bold' },
            color: '#333'
            }
        },
        y: {
            ticks: {
            font: { size: 13, weight: '500' },
            color: '#222'
            },
            grid: { color: '#f0f0f0' }
        }
        }
    },
    plugins: [ChartDataLabels]
    });

</script>

{% endblock %}